<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="shuvayatra-audio-card.html">
<link rel="import" href="shuvayatra-video-card.html">
<link rel="import" href="shuvayatra-text-card.html">

<dom-module id="shuvayatra-feed">
    <template>
        <style>
            :host {
                display: block;
            }

            .loadingIndicator {
                text-align: center;
            }

            .loadingIndicator label {
                border: 2px solid #00bbd5;
                padding: 5px 20px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s linear;
                color: #4a4a4a;
            }

            .loadingIndicator label:hover {
                background: #00bbd5;
                color: #fff;
            }

            a {
                text-decoration: none;
                color: #000;
            }

            paper-dropdown-menu {
                width: 100%;
            }

            paper-card.menu {
                width: 100%;
                padding: 10px;
            }

            paper-card.menu iron-icon {
                color: #333;
            }

            paper-card.filter-wrapper {
                margin-top: 10px;
                margin-bottom: 20px;
            }

            .search-link {
                color: #545454;
            }

            paper-card ::paper-dropdown-menu ::paper-menu-button iron-dropdown {
                width: 780px;
                left: 349px !important;
                top: 145px !important;
                margin: 0 auto;
            }

            paper-card ::paper-dropdown-menu > iron-dropdown > .dropdown-content {
                max-width: 100%;
            }

            .empty {
                width: 100%;
                min-height: 300px;
                display: table;
            }

            .empty label {
                display: table-cell;
                vertical-align: middle;
                text-align: center;
                font-size: 20px;
            }

            .empty[hidden] {
                display: none;
            }

            /*DropdownSearch*/
            .select-wrapper {
                position: relative;
            }

            .select-wrapper span.caret {
                color: initial;
                position: absolute;
                right: 0;
                top: 16px;
                font-size: 10px;
            }

            .select-wrapper input.select-dropdown {
                position: relative;
                cursor: pointer;
                background-color: transparent;
                border: none;
                outline: none;
                height: 3rem;
                font-size: 1rem;
                margin: 0;
                padding: 0;
                display: block;
                width: 100%;
            }

            .select-wrapper ul.dropdown-content {
                width: 100%;
                position: absolute;
                top: 0px;
                left: 0px;
                padding: 0;
                display: block;
                background-color: #fff;
                margin: 0;
                min-width: 100px;
                max-height: 650px;
                overflow-y: auto;
                z-index: 999;
                box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);
                list-style-type: none;
                transform: scaleY(0);
                transform-origin: left 1.5rem;
                transition: all 150ms ease-out;
            }

            .select-wrapper ul.dropdown-content.active {
                visibility: visible;
                opacity: 1;
                transform: scaleY(1);
                transition: all 150ms ease-in;
            }

            .select-wrapper ul li {
                display: list-item;
                cursor: pointer;
                min-height: 50px;
                line-height: 1.5rem;
                width: 100%;
                text-align: left;
                text-transform: none;
            }

            .select-wrapper ul li span {
                color: #4a4a4a;
                display: block;
                line-height: 22px;
                padding: 14px 16px;
            }

            .select-wrapper ul li.disabled span {
                color: rgba(0, 0, 0, 0.3);
                background-color: transparent;
            }

            .select-wrapper ul.dropdown-content li.disabled span {
                top: 0;
            }

            .select-wrapper ul li:hover {
                background-color: #eee;
            }

        </style>
        <template id="filterIf" is="dom-if" if="{{ !noFilter }}">
            <a href="/tags">
                <paper-card class="menu" elevation="2">
                    <iron-icon icon="search"></iron-icon>
                    <label>तपाईं के हेर्न चाहनुहुन्छ ? </label>
                </paper-card>
            </a>

            <iron-ajax id="filterAjax"
                       method="GET"
                       on-response="_didRespondFilter"></iron-ajax>

            <paper-card class="menu filter-wrapper" elevation="2">

                <div class="select-wrapper">
                    <span class="caret">▼</span>
                    <input type="text" class="select-dropdown" readonly value="All"/>
                    <ul class="select-dropdown dropdown-content active">
                        <li class="disabled">
                            <span>All</span>
                            <span class="caret">▼</span>
                        </li>
                        <li>
                            <span>NA - North America</span>
                        </li>
                        <li>
                            <span>EUW - Europe West </span>
                        </li>
                        <li>
                            <span>EUNE - Europe Nordic East</span>
                        </li>
                        <li>
                            <span>OCE - Oceania</span>
                        </li>
                        <li>
                            <span>TUR - Tukrey</span>
                        </li>
                    </ul>
                </div>

            </paper-card>
        </template>

        <iron-ajax id="ajax"
                   auto="{{ noFilter }}"
                   url="{{ baseUrl }}api/posts"
                   method="GET"
                   params="{{ queryParams }}"
                   last-response="{{ data }}"
                   loading="{{ isLoading }}"
                   on-response="_didRespond"
                   on-error="_onError">
        </iron-ajax>

        <!-- <iron-list id="list" items="[]" as="item"> -->
        <template id="list" is="dom-repeat" items="[]">
            <!-- <template> -->
            <div>
                <template is="dom-if" if="{{ _checkIfTypeAudio(item.type) }}">
                    <shuvayatra-audio-card class="post-card" post="{{ item }}"></shuvayatra-audio-card>
                </template>

                <template is="dom-if" if="{{ _checkIfTypeVideo(item.type) }}">
                    <shuvayatra-video-card class="post-card" post="{{ item }}"></shuvayatra-video-card>
                </template>

                <template is="dom-if" if="{{ _checkIfTypeText(item.type) }}">
                    <shuvayatra-text-card class="post-card" post="{{ item }}"></shuvayatra-text-card>
                </template>
            </div>
        </template>
        <!-- </iron-list> -->

        <div class="loadingIndicator">
            <paper-spinner active="{{ isLoading }}"></paper-spinner>
            <template is="dom-if" if="{{ !isLoading }}">
                <label on-click="_loadMoreData" hidden$="{{ !_canLoadMore(isLoading, isLastPage) }}">Load More</label>
            </template>
        </div>

        <div class="empty" hidden$="{{ _isEmpty(totalItems) }}">
            <label>कुनै सामाग्री उपलब्द छैन</label>
        </div>
    </template>
    <script>

        Polymer({
            is: 'shuvayatra-feed',
            behaviors: [Polymer.IronScrollTargetBehavior, GlobalBehavior],

            properties: {
                noFilter: {
                    type: Boolean,
                    value: false
                },

                filter: {
                    type: Object,
                    value: {},
                },

                selectedFilter: {
                    type: Object,
                    observer: '_filterChanged'
                },

                currentPage: {
                    type: Number,
                    value: 1
                },

                isLastPage: {
                    type: Boolean,
                    value: true
                },

                queryParams: {
                    type: Object,
                    value: {
                        page: 1
                    }
                },

                searchQuery: {
                    type: String,
                    observer: '_searchByQuery'
                },

                searchTag: {
                    type: String,
                    observer: '_searchByTag'
                },

                categoryId: {
                    type: Number,
                    value: -1,
                    observer: '_onCategoryChanged'
                },

                headerData: {
                    type: Object,
                    notify: true
                }
            },

            ready: function () {
                this.totalItems = -1;
                this.queryParams = {
                    page: 1
                };
            },

            _canLoadMore: function (isLoading, isLastPage) {
                return !isLoading && !this.isLastPage;
            },

            _isEmpty: function (totalItems) {
                return (totalItems !== 0);
            },

            _loadMoreData: function () {
                if (this.queryParams.page && !this.isLastPage) {
                    this.queryParams.page = this.currentPage + 1;
                    this.$.ajax.generateRequest();
                }
            },

            _didRespond: function (e) {
                var posts = e.detail.response.data;
                this.isLastPage = e.detail.response.next_page_url == null;
                var parent = this.$;

                this.currentPage = e.detail.response.current_page;
                this.totalItems = e.detail.response.total;

                posts.forEach(function (post) {
                    parent.list.push('items', post);
                });
            },

            _onError: function (e) {
                console.log(e);
                if (this.totalItems === -1) {
                    this.totalItems = 0;
                }
            },

            _didRespondFilter: function (e) {
                var temp = {};
                temp.filterBy = "category";
                temp.data = [{title: "सबै", id: this.categoryId}].concat(e.detail.response.sub_categories);
                this.filter = temp;

                var temp1 = e.detail.response;
                delete temp1.sub_categories;
                this.headerData = temp1;

                this.$.filterIf.render();
                this.$$('#filterList').selected = 0;
            },

            _filterChanged: function (value, oldValue) {
                if (value != null) {
                    if (this.filter.filterBy === "type") {
                        delete this.queryParams.category;
                        this.queryParams.post_type = value.value;
                        if (value.value == -1) {
                            delete this.queryParams.post_type;
                        }
                    } else if (this.filter.filterBy === "category") {
                        delete this.queryParams.post_type;
                        this.queryParams.category = value.value;
                        if (value.value == -1) {
                            delete this.queryParams.category;
                        }
                    }
                    this.queryParams.page = 1;
                    this.$.list.items = [];
                    this.$.ajax.generateRequest();
                }
            },

            _onCategoryChanged: function (value, oldValue) {
                if (this.categoryId !== -1) {
                    this.$.filterIf.render();
                    this.$$("#filterAjax").url = this.baseUrl + "api/category/" + this.categoryId;
                    this.$$("#filterAjax").generateRequest();

                    if (oldValue) {
                        delete this.queryParams.post_type;
                        delete this.queryParams.category;
                        delete this.queryParams.page;
                        this.queryParams.category = this.categoryId;

                        this.$.list.items = [];
                        this.$.ajax.generateRequest();
                    }
                }
            },

            _searchByTag: function (value) {
                console.log(decodeURIComponent(value));
                this.queryParams.tag = decodeURIComponent(value);
                this.$.list.items = [];
                this.currentPage = 0;
                this.isLastPage = false;
                this._loadMoreData();
            },

            _searchByQuery: function (value) {
                console.log('asd: ' + decodeURIComponent(value));
                this.queryParams.query = decodeURIComponent(value);
            },

            _checkIfTypeAudio: function (type) {
                return (type === "audio");
            },

            _checkIfTypeVideo: function (type) {
                return (type === "video");
            },

            _checkIfTypeText: function (type) {
                return (type === "text");
            },
        });

    </script>
</dom-module>

